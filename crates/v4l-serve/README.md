# v4l-serve

`v4l`経由でカメラにアクセスしてパラメータの取得、キャプチャを実行する。

## APIs

| `path`                            | desc                                  |
| --------------------------------- | ------------------------------------- |
| `GET /devices`                    | デバイス一覧を取得                    |
| `GET /device/{index}`             | `index`番目デバイスの詳細を取得       |
| `GET /device/{index}/capture`     | 指定デバイスで画像を取得              |
| `GET /device/{index}/capture/avg` | Raw画像を複数枚撮影撮影して平均を取得 |

### `GET /device/{index}`

デバイスの詳細を取得する。
`JSON`でレスポンスが返ってくる

| name     | 説明                                       |
| -------- | ------------------------------------------ |
| controls | 制御可能なパラメータのリスト               |
| formats  | カメラの出力モードとフレームサイズのリスト |

#### Controls

制御パラメータの詳細

| name      | 説明                                          |
| --------- | --------------------------------------------- |
| id        | v4lでの識別番号                               |
| typ       | データ型                                      |
| name      | 制御名                                        |
| ctrl_name | captureやv4l2-ctlで指定する場合のパラメータ名 |
| minimum   | 最小値                                        |
| maximum   | 最大値                                        |
| step      | 変更最小単位                                  |
| default   | デフォルト値                                  |

### `GET /device/{index}/capture`

指定デバイスで画像を取得します。

| query        | 説明                                                           | e.g.                    |
| ------------ | -------------------------------------------------------------- | ----------------------- |
| fourcc       | カメラの画像フォーマットの指定                                 | `RG10`                  |
| width        | 撮影画像の横幅リクエスト。実際の大きさはカメラモードに依存する | `1280`                  |
| height       | 撮影画像の縦幅リクエスト。実際の大きさはカメラモードに依存する | `720`                   |
| control      | 撮影パラメータの指定。詳細は`/device/{index}`で取得できる      | `gain=120,expose=20000` |
| buffer_count | 画像取得までに捨てるバッファ数。                               | `4(default)`            |
| outfmt       | Raw撮影時に表示可能な画像フォーマットに変換する                | `png`                   |

CSIカメラはデータの安定、パラメータの反映まで数フレームかかるため`buffer_count`は4をデフォルトとしています。

撮影時の条件はレスポンスのHTTP Headerにあります

| header                   | 説明                        |
| ------------------------ | --------------------------- |
| `X-Image-FourCC`         | 画像フォーマット            |
| `X-Image-Width`          | 画像横px                    |
| `X-Image-Height`         | 画像縦px                    |
| `X-Capture-Mill-Seconds` | Captureにかかった時間(msec) |
| `X-Control-<key>`        | 撮影条件の値                |

### `GET /device/{index}/capture/avg`

Raw画像を複数枚撮影撮影して平均を取得

| query        | 説明                                                           | e.g.                    |
| ------------ | -------------------------------------------------------------- | ----------------------- |
| fourcc       | カメラの画像フォーマットの指定                                 | `RG10`                  |
| width        | 撮影画像の横幅リクエスト。実際の大きさはカメラモードに依存する | `1280`                  |
| height       | 撮影画像の縦幅リクエスト。実際の大きさはカメラモードに依存する | `720`                   |
| control      | 撮影パラメータの指定。詳細は`/device/{index}`で取得できる      | `gain=120,expose=20000` |
| buffer_count | 画像取得までに捨てるバッファ数。                               | `4(default)`            |
| outfmt       | Raw撮影時に表示可能な画像フォーマットに変換する                | `png`                   |
| stack_count  | 平均を計算するための撮影枚数                                   | `5(default)`            |
